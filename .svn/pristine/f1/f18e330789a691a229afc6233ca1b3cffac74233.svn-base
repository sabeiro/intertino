fList <- list.files(path=".")
for(ch in chL$ch){
        siteGrp <- siteGrp2[siteGrp2$ch %in% ch,]
        siteL <- ddply(siteGrp,.(site),summarise,imps=sum(imps,na.rm=TRUE))
        siteL <- siteL[order(-siteL$imps),]
        for(form in formL){
            siteL1 <- data.frame(form = ddply(siteGrp,.(site),.fun=function(xx){sum(xx[,paste("view",form,sep=".")],na.rm=TRUE)/sum(xx[,paste("imps",form,sep=".")],na.rm=TRUE)})[2])
            colnames(siteL1) <- form
            siteL <- cbind(siteL,siteL1)
        }
        stC <- NULL
        site <- siteL$site[1]
        for(site in siteL$site){
            siteGrp <- siteGrp2[siteGrp2$site %in% site,]
            sectL <- ddply(siteGrp,.(section),summarise,imps=sum(imps,na.rm=TRUE))
            sectL <- sectL[order(-sectL$imps),]
            for(form in formL){
                sectL1 <- data.frame(form = ddply(siteGrp,.(section),.fun=function(xx){sum(xx[,paste("view",form,sep=".")],na.rm=TRUE)/sum(xx[,paste("imps",form,sep=".")],na.rm=TRUE)})[2])
                colnames(sectL1) <- form
                sectL <- cbind(sectL,sectL1)
            }
            sectV <- list(label_short=site,label_long=site)
            scC <- NULL
            for(sect in sectL$section){
                sectV1 <- list(label_short=sect,label_long=sect,values=as.numeric(sectL[sectL$section %in% sect,-1]) )
                scC <- list(scC,sectV1)
            }
            siteV1 <- list(label_short=site,label_long=site,values=as.numeric(siteL[siteL$site %in% site,-1]) )
            siteV1$children <- scC[-1]
            stC <- list(stC,siteV1)
        }
chV1 <- list(label_short=ch,label_long=ch,values=as.numeric(chL[grep(ch,chL$ch),-1]))
        chV1$children <- stC[-1]
        chC <- list(chC,chV1)
chC

cc
p <- ggplot(melted,aes(x=Demo.Segment,y=value,color=variable,fill=variable,group=Gender))+
    ##geom_density(alpha=0.3,stat="identity",position="dodge") +
    geom_bar(alpha=0.3,stat="identity",position="identity") +
    geom_text(data=audTot,aes(x=x,y=y,label=paste(round(value),"%",sep="")),color="black") +
    facet_grid(. ~ variable) + ##,scales = "free", space = "free") +
    theme(
        legend.position="bottom",legend.box = "horizontal",
        ##axis.text.x = element_text(angle = 30,margin=margin(-10,0,0,0)),
        axis.ticks = element_blank(),
        strip.text.y = element_text(size=12, face="bold"),
        strip.background = element_rect(colour="white", fill="#EEEEEE"),
        ##axis.text.x = element_blank(),
        panel.background = element_blank()
    ) +
    scale_y_continuous(breaks=c(-3,3),labels=c("M","F")) +
    scale_colour_discrete(guide = FALSE) +
    coord_flip() +
    labs(x=gLabel[1],y=gLabel[2],title=gLabel[3],color=gLabel[4])
a
leaps<-regsubsets(cpm ~ format + client,data=ag[1:500,],nbest=10)
