#!/usr/bin/env Rscript
##setwd('/home/sabeiro/lav/media/')
##U:\MARKETING\Inventory\Analisi VM\Inventory VM
setwd('C:/users/giovanni.marelli/lav/media/')

source('script/graphEnv.R')
library(stringi)
library(wordcloud)
library(RColorBrewer)
library(igraph)
library(ggplot2)
library(tm)
library(cluster)
##library(FactoMineR)
library(plyr)

source('script/graphEnv.R')
source('script/CommLibrary.R')
source('script/comLoad.R')

fs <- read.csv('raw/siteChannelDevFormat.csv',encoding="UTF-8")
siteChannel <- read.csv('raw/siteChannel.csv',encoding="UTF-8")
fs$channel <- sapply(fs$Site,function(x) siteChannel[grepl(x,siteChannel$Site),"Canale"][1])
channel <- c("news","entertainment","young","sport","women")
head(fs)
fs$x <- fs$DeviceType
fs$y <- fs$Imps
fs1 <- fs
##cleaning up
fs$AdDescription <- tryTolower(fs$AdDescription)
fs$AdDescription <- gsub("970x250","masthead",fs$AdDescription)
##-------------channel-comp---------------------
source("script/comImpr.R")
fs$x <- fs$DeviceType
fs$y <- fs$Imps
timeVar <- c("Desktop","Mobile","Tablet","Unknown")
filterList <- c("300x250","970x250","300x600","preroll","728","masthead","skin","320x50","640x920","160x600","15 secondi","160x600","exp-video")
filterName <- c("AdDescription")
sectType <- c("tutti")
metricVar <- c("Imps")
metricType <- c("measured")
devFile <- channel
mTab <- data.frame(x = c(filterList,"rest","total"))
rTab <- mTab#head(mTab[with(mTab,order(-y)),],n=100)
sectGrp <<- data.frame(channel = rep(rTab$x,length(timeVar)))
sectGrp$x <- as.vector(sapply(timeVar,function(x) rep(x,length(rTab$x))))
dev <- devFile[1]
for(dev in devFile){
    sectType <- paste(dev,"",sep="")
    set <- grepl(dev,fs1$channel)
    print(sectType)
    set[is.na(set)] <- FALSE
    fs <- fs1[set,]
    if(any(set)){
        bstack <- comImprFilterMelt(fs,sectType,timeVar,metricVar,metricType,filterList,filterName)
        sectGrp$var <- bstack$volume
        colnames(sectGrp)[colnames(sectGrp)=='var'] <- sectType
    }
    else{print("No elements selectable")}
}

write.table(sectGrp,"out/channelDevFormat.csv",row.names=FALSE,append=FALSE,sep=",")

