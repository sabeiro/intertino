
FROM debian:11


# Install software

ENV DEBIAN_FRONTEND=noninteractive

RUN apt update && apt upgrade -y && apt clean

RUN apt install -y supervisor rsyslog \
	postfix dovecot-core dovecot-imapd dovecot-lmtpd dovecot-managesieved opendkim \
	roundcube roundcube-sqlite3 roundcube-plugins \
	certbot openssh-server rsync \
	&& apt clean \
	\
	&& sed -i s/bullseye/bookworm/ /etc/apt/sources.list \
	&& apt update \
	&& apt install -y postfix


# Server hostname & all managed domains

ARG SERVER_HOSTNAME="lightmetermail.io"
ENV SERVER_HOSTNAME $SERVER_HOSTNAME

ENV VMAILBOX_DOMAINS="lightmetermail.io outreach.lightmeter.io heylightmeter.com agencycybersecurity.com atlas-mail.io heytheneo.io campfireone.com campfireremote.com getstackshine.com getagencycyber.com"


# Supervisord

COPY origconf/etc/supervisor/10-mail.conf /etc/supervisor/conf.d/10-mail.conf
COPY scripts/startup-script.sh /startup-script.sh


# Postfix

COPY origconf/etc/postfix/vmailbox       /etc/postfix/vmailbox
COPY origconf/etc/postfix/vmail_aliases  /etc/postfix/vmail_aliases
COPY origconf/etc/postfix/sender_bcc     /etc/postfix/sender_bcc
COPY origconf/etc/postfix/sasl_passwd    /etc/postfix/sasl_passwd

COPY origconf/etc/postfix/recipient_transport_map_base  /etc/postfix/recipient_transport_map_base
COPY origconf/etc/postfix/sender_transport_map_base     /etc/postfix/sender_transport_map_base
COPY origconf/etc/postfix/network_table                 /etc/postfix/network_table

COPY scripts/postconf.sh /postconf.sh
RUN /postconf.sh


# Dovecot

COPY origconf/etc/dovecot/conf.d/99-lightmeter.conf /etc/dovecot/conf.d/99-lightmeter.conf

COPY origconf/etc/dovecot/imap.passwd /etc/dovecot/imap.passwd

## do not use system user's for authenticating
RUN sed 's|^!include auth-system.conf\.ext|#\0|g' -i /etc/dovecot/conf.d/10-auth.conf

## create temporary empty cert files, waiting for them to be synced from router
RUN mkdir -p /etc/letsencrypt/live/lightmeter
RUN touch /etc/letsencrypt/live/lightmeter/fullchain.pem
RUN touch /etc/letsencrypt/live/lightmeter/privkey.pem


# OpenDkim

COPY origconf/etc/opendkim/ /etc/opendkim
RUN chmod 644 /etc/opendkim/KeyTable /etc/opendkim/SigningTable /etc/opendkim/TrustedHosts
RUN chown opendkim:opendkim -R /etc/opendkim
RUN chmod -R 700 /etc/opendkim/keys
RUN chown opendkim:opendkim /etc/opendkim/keys/*/default.private

RUN sed 's/^SOCKET=/#SOCKET=/g'    -i /etc/default/opendkim
RUN sed 's/^Socket\s/#Socket /g'   -i /etc/opendkim.conf
RUN echo "SOCKET=inet:12345@localhost" >> /etc/default/opendkim
RUN echo "Socket inet:12345@localhost" >> /etc/opendkim.conf

RUN cat /etc/opendkim/opendkim.conf.add >> /etc/opendkim.conf


# Roundcube

## activate /roundcube alias to actually have access

RUN sed -i 's/#\s*Alias \/roundcube/Alias \/roundcube/'   /etc/apache2/conf-enabled/roundcube.conf

## database config

COPY origconf/etc/roundcube/debian-db.php /etc/roundcube/debian-db.php
RUN chmod 644 /etc/roundcube/debian-db.php

COPY origconf/etc/roundcube/config.lightmeter.inc.php /etc/roundcube/config.lightmeter.inc.php
RUN echo "require '/etc/roundcube/config.lightmeter.inc.php';" >> /etc/roundcube/config.inc.php

## Fix database file path error
RUN mkdir -p /var/lib/roundcube/SQL/
RUN cp /usr/share/roundcube/SQL/sqlite.initial.sql /var/lib/roundcube/SQL/sqlite.initial.sql

## Apache
COPY origconf/etc/apache2/sites-available/all-ssl.conf         /etc/apache2/sites-available/all-ssl.conf
COPY origconf/etc/apache2/sites-available/99-redirect-all.conf /etc/apache2/sites-available/99-redirect-all.conf
RUN a2enmod ssl
RUN a2enmod rewrite
RUN a2dissite 000-default.conf
RUN a2ensite all-ssl
RUN a2ensite 99-redirect-all


# Sieve

RUN mkdir -p /usr/local/etc/dovecot/sieve/global


# Start everything

ENTRYPOINT ["/startup-script.sh"]
